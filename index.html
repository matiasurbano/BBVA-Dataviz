  <!DOCTYPE html>
  <html>

  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>BBVA | DataViz</title>

    <link rel="stylesheet" href="css/tipsy.css">
    <link rel="stylesheet" href="css/default.css">
    <link rel="stylesheet" href="css/default.date.css">
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/jquery-ui.css">
    <link rel="stylesheet" href="css/select2.css">
    <link rel="stylesheet" href="css/toasty-min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/c3.min.css">


    <script src="js/jquery-1.10.2.min.js"></script>
    <script src="js/underscore-min.js"></script>s
    <script src="js/leaflet.js"></script>
    <script src="js/leaflet.ajax.min.js"></script>
    <script src="js/select2.js"></script>
    <script src="js/leaflet.spin.js"></script>
    <script src="js/spin.js"></script>
    <script src="js/toasty-min.js"></script>
    <script src="js/d3.v3.min.js"></script>
    <script src="js/c3.min.js"></script>


    <script src="js/AirQualityService.js"></script>
    <script src="js/MapHelper.js"></script>
    <script src="js/BBVAService.js"></script>
    <script src="js/common.js"></script>


  </head>

  <body id="dummybodyid" style="">

    <div id="selector-pobreza" class="selector" style="
    position: absolute;
    top: 10px;
    z-index: 999;
    width: 100%;
    height: 30px;
    line-height: 30px;
    opacity: 0.8;     filter: alpha(opacity=80); /* For IE8 and earlier */;
    ">Air Quality and the Market</div>
    <div id="map" class="leaflet-container leaflet-fade-anim" tabindex="0">

    </div>
    <div id="selector">
      <div id="selector-pobreza" class="selector">Control Panel</div>
    </div>
    <div class="varlist" id="varlist_pobreza">
      <div class="nombre-variable varname nombre-variable-selected">
        <select id="cmbCategories" style="width:100%">
        </select>
      </div>
      <div class="nombre-variable varname nombre-variable-selected">
        <select id="cmbZipCodes" style="width:100%">
        </select>
      </div>
    </div>

    <div class="box-title" style="
    position: absolute;
    bottom: 24px;
    right: 15px;
    ">
    <div id="legend">
      <div id="legend-rezago000510">
        <div style="background-color:red;" class="legend-box">Selected</div>
        <div style="background-color:black;" class="legend-box">Origin</div>
        <div style="background-color:grey;" class="legend-box">Not apply</div>
        <div style="clear:both;"></div>
      </div>
    </div>
  </div>

  <div id="slider-box">
    <div class="dark year blue-dark selected-year"  id="20131101-20131130">Nov 13</div>
    <div class="dark year blue-dark"  id="20131201-20131231">Dec 13</div>
    <div class="dark year blue-dark"  id="20140101-20140131">Jan 14</div>
    <div class="dark year blue-dark"  id="20140201-20140228">Feb 14</div>
    <div class="dark year blue-dark"  id="20140301-20140331">Mar 14</div>
    <div class="dark year blue-dark"  id="20140401-20140430">Apr 14</div>
  </div>

  <div id="panelInfo" style="">
    <div class="dark nom_mun blue-dark">ZipCode Details</div>
    <div class="mundata-box light state_box blue-light">
      <div class="state_name">ZipCode: 06010</div>
      <div class="num_mun">Municipality: CUAUHTMOC</div>
    </div>
<!--     <div class="box-title">
      <div class="light text datos-title" style="background: white; color: black;">Avg. <b>125.61</b> Num. <b>945 </b> <img style="float: left; margin-top: -5px;" height="25" width="35" src="img/men.png"> </div>
    </div>
    <div class="box-title">
      <div class="light text datos-title" style="background: white; color: black;">Avg. <b>126.1</b> Num. <b>1109 </b> <img style="float: left; margin-top: -5px;" height="25" width="35" src="img/women.png"> </div>
    </div> -->
    <div class="box-title">
      <div id="chart_avg" style="float:left;"></div>  
      <div id="chart_num" style="float:left;"></div>  
    </div>
  </div>

  <script type="text/javascript" charset="utf-8">
    $(document).ready(function() { 
    // UI Elements
    var ui_cmbCategories = $("#cmbCategories"),
    ui_cmbZipCodes = $("#cmbZipCodes");
    // Map Elements
    var zipCodesLayer,
    districtsLayer,
    airQualityLayer;  

    var optFilter = {
      zipcode  : '06010' || null,
      category : 'mx_fastfood' || null,
      date_min : '20131101' || null,
      date_max : '20131130' || null,
      by       : 'month'
    };

    // defining map
    var map = new L.Map('map', {
      maxZoom: 20,
      minZoom: 1
    }).setView([19.360916, -99.146691], 11);
    L.tileLayer('http://{s}.tile.stamen.com/toner-lite/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      detectRetina: true
    }).addTo(map);
    ui_cmbCategories.on('change',function(e){
      console.log('Categories combo change');  
      var category_code = $(this).val();
      if (category_code){
        optFilter.category = category_code;
        triggerOptFilter();
      }        
    });
    ui_cmbZipCodes.on('change',function(e){
      console.log('ZipCode combo change');
      var zip_code = $(this).val();
      if (zip_code){
        optFilter.zipcode = zip_code;
        triggerOptFilter();
      }        
    });
    var ui_optYear = $(".year");
    ui_optYear.click(function(event) {
      ui_optYear.siblings().removeClass("selected-year");
      $(event.target).addClass("selected-year")
      if (event.target.id){
        optFilter.date_min = event.target.id.split('-')[0];
        optFilter.date_max = event.target.id.split('-')[1];
        triggerOptFilter();
      }
    });


    

    function triggerOptFilter(){
      var opts = {
        zipcode : optFilter.zipcode,
        category : optFilter.category,
        date_min : optFilter.date_min,
        date_max : optFilter.date_max,
        by: optFilter.by
      };



      BBVAService.getCustomerZipCodes(opts.zipcode,opts.category,opts.date_min,opts.date_max,opts.by, function(data){
       // var mainZipcode = '',
       // relatedZipcodes = [];
        //TODO: FIX THIS!!! Just a walkaround
        window.mainZipcode = opts.zipcode;
        window.relatedZipcodes = data[0].zipcodes;
        function fixedColorByType(feature){
          var selectedZipCode = feature.properties.POSTALCODE;
          var res = _.find(relatedZipcodes, function(obj){ return obj.label==selectedZipCode })
          if (selectedZipCode == mainZipcode || res !== undefined){
            if (selectedZipCode==window.mainZipcode){
              displayInformationPanel(feature.properties);
              return 'red';                
            }
            return 'black';  
          }             
          return 'grey';
        };
        function style(feature) {
          return {
            weight: 1,
            opacity: 1,
            color: 'black',
            fillOpacity: 0.7,
            fillColor: fixedColorByType(feature)  
          };
        }
        var layer;
        
        function highlightFeature(e) {
          layer = e.target;
          layer.setStyle({
            weight: 5,
            color: '#666',
            dashArray: '',
            fillOpacity: 0.7
          });
          if (!L.Browser.ie && !L.Browser.opera) {
            layer.bringToFront();
          }
        }
        function resetHighlight(e) {
          zipCodesLayer.resetStyle(e.target);
        }
        function onEachFeature(feature, layer) {
          var selectedZipCode = feature.properties.POSTALCODE;
          var areaClick_handler = function(e){
            var selectedZipCode = feature.properties.POSTALCODE;

            optFilter.zipcode = selectedZipCode;
            ui_cmbZipCodes.select2('val', selectedZipCode);
            triggerOptFilter();

          };

          if (selectedZipCode == window.mainZipcode){
            map.fitBounds(layer.getBounds(),{maxZoom: 12, padding: [50,50]});          
          }

          var res = _.find(relatedZipcodes, function(obj){ return obj.label==selectedZipCode })
          if (selectedZipCode == mainZipcode || res !== undefined){
            var layerCenter = layer.getBounds();
            var zipLabel = L.marker(layerCenter.getCenter(), {
              icon: L.divIcon({                
                className: 'text-labels', 
                html: selectedZipCode
              }),
              draggable: false           
            });
            zipLabel.on('click',areaClick_handler)
            zipLabel.addTo(zipCodesLayer); 
          }      


          layer.on({
            // mouseover: highlightFeature,
            // mouseout: resetHighlight,
            click: areaClick_handler
          });
        }
        function filter(feature, layer) {
          var selectedZipCode = feature.properties.POSTALCODE;
          var res = _.find(relatedZipcodes, function(obj){ return obj.label==selectedZipCode })
          return (selectedZipCode == mainZipcode || res !== undefined)
        }
        if (zipCodesLayer !== undefined){
          map.removeLayer(zipCodesLayer);  
        }
        zipCodesLayer = new L.GeoJSON.AJAX("data/df-zipcodes.geojson", {
          style: style,
          onEachFeature: onEachFeature
        });       
        map.addLayer(zipCodesLayer);
      });  
}



triggerOptFilter();





    // Add Mexico DF districts to map
    districtsLayer = new L.GeoJSON.AJAX("data/df-municipalities.geojson", {
      style: style_districtsLayer
    });
    map.addLayer(districtsLayer);  








    function displayInformationPanel(metadata){
      var opts = {
        zipcode : optFilter.zipcode,
        category : optFilter.category,
        date_min : optFilter.date_min,
        date_max : optFilter.date_max,
        by: optFilter.by
      };
      var men_num_payments,
      men_avg,
      wom_num_payments,
      wom_avg;


      var ui_infoPanel = $('#panelInfo');
      console.log(metadata);

      ui_infoPanel.show(200);

      BBVAService.getGenderByZipCodes(metadata.POSTALCODE,opts.category,opts.date_min,opts.date_max,function(data){
        console.log(data);
        if (data[0] && data[0].histogram[0]){
          // men stats
          men_num_payments = data[0].histogram[0].num_payments;
          men_avg = data[0].histogram[0].avg;
          // men stats
          wom_num_payments = data[0].histogram[1].num_payments;
          wom_avg = data[0].histogram[1].avg


          var chart_avg = c3.generate({
            bindto: '#chart_avg',
            legend: {
              show: true
            },
            data: {
              columns: [
              ['men', men_avg],
              ['women', wom_avg]
              ],
              type: 'donut'
            },
            donut:{
              title:'Avg',
              width: 20,
              label: {
                show: false,
              }
            },
            color: {
              pattern: ['#303FE3', '#E841CF']
            },
            size: {
              width: 150,
              height: 120
            },
          });


          var chart_num = c3.generate({
            bindto: '#chart_num',
            legend: {
              show: false
            },
            data: {
              columns: [
              ['men', wom_num_payments],
              ['women', men_num_payments]
              ],
              type: 'bar'//,
              // groups: [
              // ['women', 'men']
              // ]
            },
            color: {
              pattern: ['#303FE3', '#E841CF']
            },
            bar: {
              title:'Avg',
              width: {
            ratio: 0.3 // this makes bar width 50% of length between ticks
          }
        },
        axis: {
          x: {
            label: {
              text: 'Num. of payments',
              position: 'outer-top'
            }
          }
          ,
          y: {
            tick: {
              values: [50, 300, 500, 1000, 1500,5000, 10000]
            }
          }
        },
        size: {
          width: 150,
          height: 120
        },
      });

          // update charts
          // var chart_avg = c3.generate({
          //   bindto: '#chart_avg',
          //   label: {
          //     show: false
          //   },
          //   data: {
          //     columns: [
          //     ['data1', men_avg],
          //     ['data2', wom_avg],
          //     ],
          //     type : 'donut',
          //     onclick: function (d, i) { console.log("onclick", d, i); },
          //     onmouseover: function (d, i) { console.log("onmouseover", d, i); },
          //     onmouseout: function (d, i) { console.log("onmouseout", d, i); }
          //   },
          //   color: {
          //     pattern: ['#1f77b4', '#aec7e8', '#ff7f0e', '#ffbb78', '#2ca02c', '#98df8a', '#d62728', '#ff9896', '#9467bd', '#c5b0d5', '#8c564b', '#c49c94', '#e377c2', '#f7b6d2', '#7f7f7f', '#c7c7c7', '#bcbd22', '#dbdb8d', '#17becf', '#9edae5']
          //   },
          //   size: {
          //     width: 150,
          //     height: 150
          //   },
          //   padding: {
          //     right: 0,
          //     top:0,
          //     left:0,
          //     bottom:0
          //   },
          //   legend: {
          //     position: 'bottom'
          //   },
          //   pie: {
          //     title: "avg",
          //     label: {
          //       format: function (value, ratio, id) {
          //         return d3.format('$')(value);
          //       }
          //     }
          //   },
          //   donut: {
          //     width: 20,
          //     title: "avg",
          //     label: {
          //       format: function (value, ratio, id) {
          //         return d3.format('$')(value);
          //       }
          //     }
          //   }
          // });
}


});

};


var airQualityMarkers = [];
airQuality.forEach(function(elem){

  var markerClass='';
  if (elem.aqi<50) markerClass = 'count-icon-00-50';
  else if (elem.aqi>50 && elem.aqi<100) markerClass = 'count-icon-50-100';
  else if (elem.aqi>100 && elem.aqi<150) markerClass = 'count-icon-100-150';
  else if (elem.aqi>150 && elem.aqi<200) markerClass = 'count-icon-150-200';
  else markerClass = 'count-icon';

  var marker = L.marker([
    elem.lat,
    elem.lon
    ], {
      icon: L.divIcon({
        className: markerClass,
        html: elem.aqi,
        iconSize: [40, 40]
      })
    })
  airQualityMarkers.push(marker);
  var imageInfo = "<div style='z-index:9999;'><iframe src='http://aqicn.org/aqicn/json/mapinfo/@00000" + elem.x + "/info.html?" + elem.x + "&h=250' width=300' height='300' frameborder='0'></iframe></div>";
  marker.bindPopup(imageInfo).openPopup();
  marker.addTo(map);
});



});

</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57306667-1', 'matiasurbano.github.io');
  ga('send', 'pageview');

</script>


</body>

</html>