  <!DOCTYPE html>
  <html>

  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>BBVA | DataViz</title>

    <link rel="stylesheet" href="css/tipsy.css">
    <link rel="stylesheet" href="css/default.css">
    <link rel="stylesheet" href="css/default.date.css">
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/jquery-ui.css">
    <link rel="stylesheet" href="css/select2.css">
    <link rel="stylesheet" href="css/toasty-min.css">
    <link rel="stylesheet" href="css/style.css">


    <script src="js/jquery-1.10.2.min.js"></script>
    <script src="js/underscore-min.js"></script>s
    <script src="js/leaflet.js"></script>
    <script src="js/leaflet.ajax.min.js"></script>
    <script src="js/select2.js"></script>
    <script src="js/leaflet.spin.js"></script>
    <script src="js/spin.js"></script>
    <script src="js/toasty-min.js"></script>

    <script src="js/MapHelper.js"></script>
    <script src="js/BBVAService.js"></script>
    <script src="js/common.js"></script>


  </head>

  <body id="dummybodyid" style="">
    <div id="map" class="leaflet-container leaflet-fade-anim" tabindex="0">

    </div>
    <div id="selector">
      <div id="selector-pobreza" class="selector">Control Panel</div>
    </div>
    <div class="varlist" id="varlist_pobreza">
      <div class="nombre-variable varname nombre-variable-selected">
        <select id="cmbCategories" style="width:100%">
        </select>
      </div>
      <div class="nombre-variable varname nombre-variable-selected">
        <select id="cmbZipCodes" style="width:100%">
        </select>
      </div>
    </div>

    <div class="box-title" style="
        position: absolute;
        bottom: 24px;
        right: 15px;
       ">
        <div id="legend">
            <div id="legend-rezago000510">
                <div style="background-color:red;" class="legend-box">Selected</div>
                <div style="background-color:black;" class="legend-box">Origin</div>
                <div style="background-color:grey;" class="legend-box">Not apply</div>
                <div style="clear:both;"></div>
            </div>
        </div>
    </div>

    <div id="slider-box">
      <div class="dark year blue-dark selected-year"  id="20131101-20131130">Nov 13</div>
      <div class="dark year blue-dark"  id="20131201-20131231">Dec 13</div>
      <div class="dark year blue-dark"  id="20140101-20140131">Jan 14</div>
      <div class="dark year blue-dark"  id="20140201-20140228">Feb 14</div>
      <div class="dark year blue-dark"  id="20140301-20140331">Mar 14</div>
      <div class="dark year blue-dark"  id="20140401-20140430">Apr 14</div>
    </div>

    <script type="text/javascript" charset="utf-8">
      $(document).ready(function() { 
    // UI Elements
    var ui_cmbCategories = $("#cmbCategories"),
    ui_cmbZipCodes = $("#cmbZipCodes");
    // Map Elements
    var zipCodesLayer,
    districtsLayer,
    mainInfoPanel;

    var optFilter = {
      zipcode  : '06010' || null,
      category : 'mx_fastfood' || null,
      date_min : '20131101' || null,
      date_max : '20131130' || null,
      by       : 'month'
    };

    // defining map
    var map = new L.Map('map', {
      maxZoom: 20,
      minZoom: 1
    }).setView([19.360916, -99.146691], 11);


    L.tileLayer('http://{s}.tile.stamen.com/toner-lite/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      detectRetina: true
    }).addTo(map);


    ui_cmbCategories.on('change',function(e){
      console.log('Categories combo change');  
      var category_code = $(this).val();

      if (category_code){
        optFilter.category = category_code;
        triggerOptFilter();
      }        
    });

    ui_cmbZipCodes.on('change',function(e){
      console.log('ZipCode combo change');
      var zip_code = $(this).val();

      if (zip_code){
        optFilter.zipcode = zip_code;
        triggerOptFilter();
      }        
    });

    var ui_optYear = $(".year");
    ui_optYear.click(function(event) {
      ui_optYear.siblings().removeClass("selected-year");
      $(event.target).addClass("selected-year")

      if (event.target.id){
        optFilter.date_min = event.target.id.split('-')[0];
        optFilter.date_max = event.target.id.split('-')[1];
        triggerOptFilter();
      }

    });
      

    function triggerOptFilter(){
      console.log('trigger');

      var opts = {
        zipcode : optFilter.zipcode,
        category : optFilter.category,
        date_min : optFilter.date_min,
        date_max : optFilter.date_max,
        by: optFilter.by
      };

      BBVAService.getCustomerZipCodes(opts.zipcode,opts.category,opts.date_min,opts.date_max,opts.by, function(data){
       // var mainZipcode = '',
       // relatedZipcodes = [];

        //TODO: FIX THIS!!! Just a walkaround
        window.mainZipcode = opts.zipcode;
        window.relatedZipcodes = data[0].zipcodes;

        function fixedColorByType(feature){

          var selectedZipCode = feature.properties.POSTALCODE;
          var res = _.find(relatedZipcodes, function(obj){ return obj.label==selectedZipCode })

          if (selectedZipCode == mainZipcode || res !== undefined){
            if (selectedZipCode==window.mainZipcode){
              mainInfoPanel.update(feature.properties);
              return 'red';                
            }
            return 'black';  
          }             
          return 'grey';

        };

        function style(feature) {
          return {
            weight: 1,
            opacity: 1,
            color: 'black',
            fillOpacity: 0.4,
            fillColor: fixedColorByType(feature)
          };
        }
        var layer;
        
        function highlightFeature(e) {
          layer = e.target;

          layer.setStyle({
            weight: 5,
            color: '#666',
            dashArray: '',
            fillOpacity: 0.7
          });

          if (!L.Browser.ie && !L.Browser.opera) {
            layer.bringToFront();
          }

          mainInfoPanel.update(layer.feature.properties);
        }


        function resetHighlight(e) {
          zipCodesLayer.resetStyle(e.target);
          mainInfoPanel.update();
        }

        function onEachFeature(feature, layer) {
          var selectedZipCode = feature.properties.POSTALCODE;
          if (selectedZipCode == window.mainZipcode){
            map.fitBounds(layer.getBounds(),{maxZoom: 12, padding: [50,50]});
          }


          layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight,
            click: function(e){
              var selectedZipCode = feature.properties.POSTALCODE;
              var res = _.find(relatedZipcodes, function(obj){ return obj.label==selectedZipCode })

              if (selectedZipCode == mainZipcode || res !== undefined){
                map.fitBounds(e.target.getBounds(),{maxZoom: 12, padding: [50,50]});

              }
              else{
                optFilter.zipcode = selectedZipCode;
                ui_cmbZipCodes.select2('val', selectedZipCode);
                triggerOptFilter();
              }
            }
          });
        }

        function filter(feature, layer) {
          var selectedZipCode = feature.properties.POSTALCODE;
          var res = _.find(relatedZipcodes, function(obj){ return obj.label==selectedZipCode })

          return (selectedZipCode == mainZipcode || res !== undefined)
        }

        if (zipCodesLayer !== undefined){
          map.removeLayer(zipCodesLayer);           
        }

        zipCodesLayer = new L.GeoJSON.AJAX("data/df-zipcodes.geojson", {
          style: style,
          onEachFeature: onEachFeature,
         // filter: filter
       });
        map.addLayer(zipCodesLayer);

      });  
}

triggerOptFilter();


function style_districtsLayer(feature) {
  return {
    weight: 1,
    opacity: 1,
    color: 'black',
    fillOpacity: 0.4,
    fillColor: getFixedColor(feature)
  };
}
    // Add Mexico DF districts to map
    districtsLayer = new L.GeoJSON.AJAX("data/df-municipalities.geojson", {
      style: style_districtsLayer
    });
    map.addLayer(districtsLayer);  

  // control that shows state info on hover
  var mainInfoPanel = L.control();

  mainInfoPanel.onAdd = function (map) {
    this._div = L.DomUtil.create('div', 'info');
    this.update();
    return this._div;
  };

  mainInfoPanel.update = function (props) {
    var that = this,
    panelHTML ='';


    if (props){

      var opts = {
        category : optFilter.category,
        date_min : optFilter.date_min,
        date_max : optFilter.date_max
      };

      var selectedZipCode = props.POSTALCODE;

      if (selectedZipCode == mainZipcode){


        // panelHTML += 
        // "<div id='datos_mun' style='z-index:9999;'>"+
        // " <div class='dark nom_mun blue-dark'>ZipCode Details</div> " +
        // " <div class='mundata-box light state_box blue-light'> " +
        // "   <div class='state_name'>ZipCode:      " + props.POSTALCODE + "</div> " +
        // "   <div class='num_mun'   >Municipality: "  + props.MUN_NAME +  "</div> " +
        // " </div> ";

        // panelHTML += 
        // " <div class='box-title'> " + 
        // "      <div class='light text datos-title' style='background: white; color: black;'>" +
        // "            <img style=' margin-top: -5px;' height='22' width='22' src='img/spinner.gif'>  " + 
        // "      </div> " + 
        // "  </div> ";

        // that._div.innerHTML = panelHTML;


      // get more informacion about
      BBVAService.getGenderByZipCodes(props.POSTALCODE,opts.category,opts.date_min,opts.date_max,function(data){


        if (data[0] && data[0].histogram[0]){
          // men stats
          men_num_payments = data[0].histogram[0].num_payments;
          men_avg = data[0].histogram[0].avg;

          // men stats
          wom_num_payments = data[0].histogram[1].num_payments;
          wom_avg = data[0].histogram[1].avg
        }

        that._div.innerHTML = '';
        panelHTML += 
        "<div id='datos_mun' style='z-index:9999;'>"+
        " <div class='dark nom_mun blue-dark'>ZipCode Details</div> " +
        " <div class='mundata-box light state_box blue-light'> " +
        "   <div class='state_name'>ZipCode:      " + props.POSTALCODE + "</div> " +
        "   <div class='num_mun'   >Municipality: "  + props.MUN_NAME +  "</div> " +
        " </div> ";

        if (data[0] && data[0].histogram[0]){

          panelHTML += 
          " <div class='box-title'> " + 
          "      <div class='light text datos-title' style='background: white; color: black;'>Avg.  <b>" + men_avg + "</b> Num. <b>" + men_num_payments + " </b> " +
          "            <img style='float: left; margin-top: -5px;' height='25' width='35' src='img/men.png'>  " + 
          "      </div> " + 
          "  </div> " + 
          " <div class='box-title'> " + 
          "      <div class='light text datos-title' style='background: white; color: black;'>Avg.  <b>" + wom_avg + "</b> Num. <b>" + wom_num_payments +  " </b> " +
          "            <img style='float: left; margin-top: -5px;' height='25' width='35' src='img/women.png'>  " + 
          "      </div> " +  
          "  </div> ";

        }

        that._div.innerHTML = panelHTML;
      });


}else{
 that._div.innerHTML = 
 "<div id='datos_mun' style='z-index:9999;'>"+
 " <div class='dark nom_mun blue-dark'>ZipCode Details</div> " +
 " <div class='mundata-box light state_box blue-light'> " +
 "   <div class='state_name'>ZipCode:      " + props.POSTALCODE + "</div> " +
 "   <div class='num_mun'   >Municipality: "  + props.MUN_NAME +  "</div> " +
 " </div> ";


}





}
};

mainInfoPanel.addTo(map);



});


</script>
</body>

</html>